<app-menu-cima></app-menu-cima>

<div class="password-container">
  <div class="password-form">

    <!-- Títulos dinâmicos -->
    <h2 *ngIf="mode === 'verify'">Verifique seu E-mail (Cadastro)</h2>
    <h2 *ngIf="mode === 'reset'">Crie sua Nova Senha (Via Link)</h2>
    <h2 *ngIf="mode === 'forgot' && forgotFlowStep === 'email'">Recuperar Senha</h2>
    <h2 *ngIf="mode === 'forgot' && forgotFlowStep === 'code'">Verifique seu E-mail (Recuperação)</h2>
    <h2 *ngIf="mode === 'forgot' && forgotFlowStep === 'password'">Crie sua Nova Senha</h2>

    <!-- Subtítulos / instruções -->
    <p *ngIf="mode === 'verify'">
      Enviamos um código de 6 dígitos para o seu e-mail. Por favor, insira-o abaixo para ativar sua conta.
    </p>
    <p *ngIf="mode === 'reset'">
      Por favor, insira e confirme sua nova senha.
    </p>
    <p *ngIf="mode === 'forgot' && forgotFlowStep === 'email'">
      Insira seu e-mail para receber o código de recuperação.
    </p>
    <p *ngIf="mode === 'forgot' && forgotFlowStep === 'code'">
      Um código de 6 dígitos foi enviado para seu e-mail. Insira-o abaixo para continuar.
    </p>
    <p *ngIf="mode === 'forgot' && forgotFlowStep === 'password'">
      Código validado! Agora insira e confirme sua nova senha.
    </p>

    <!-- Mensagens -->
    <div *ngIf="successMessage" class="message success">
      {{ successMessage }}
      <span *ngIf="mode === 'reset' || (mode === 'forgot' && forgotFlowStep === 'password')">
        &nbsp;Redirecionando para o login...
      </span>
    </div>

    <div *ngIf="errorMessage" class="message error">
      {{ errorMessage }}
    </div>

    <!-- Formulário -->
    <form [formGroup]="form" (ngSubmit)="onSubmit()">

      <!-- VERIFY MODE -->
      <ng-container *ngIf="mode === 'verify'">
        <div class="input-group">
          <label for="email">E-mail</label>
          <input type="email" id="email" formControlName="email" class="form-control" />
          <div *ngIf="form.get('email')?.invalid && form.get('email')?.touched" class="invalid-feedback">
            <span *ngIf="form.get('email')?.errors?.['required']">E-mail é obrigatório.</span>
            <span *ngIf="form.get('email')?.errors?.['email']">E-mail inválido.</span>
          </div>
        </div>

        <div class="input-group">
          <label for="code">Código de 6 dígitos</label>
          <input type="text" id="code" formControlName="code" class="form-control" />
          <div *ngIf="form.get('code')?.invalid && form.get('code')?.touched" class="invalid-feedback">
            <span *ngIf="form.get('code')?.errors?.['required']">Código é obrigatório.</span>
            <span *ngIf="form.get('code')?.errors?.['minlength'] || form.get('code')?.errors?.['maxlength']">O código deve ter 6 dígitos.</span>
          </div>
        </div>
      </ng-container>

      <!-- RESET MODE (via link token) -->
      <ng-container *ngIf="mode === 'reset'">
        <div class="input-group">
          <label for="senha">Nova Senha</label>
          <input type="password" id="senha" formControlName="senha" class="form-control" />
          <div *ngIf="form.get('senha')?.invalid && form.get('senha')?.touched" class="invalid-feedback">
            <span *ngIf="form.get('senha')?.errors?.['required']">Senha é obrigatória.</span>
            <span *ngIf="form.get('senha')?.errors?.['minlength']">Senha deve ter no mínimo 6 caracteres.</span>
          </div>
        </div>

        <div class="input-group">
          <label for="confirmarSenha">Confirmar Nova Senha</label>
          <input type="password" id="confirmarSenha" formControlName="confirmarSenha" class="form-control" />
          <div *ngIf="form.get('confirmarSenha')?.invalid && form.get('confirmarSenha')?.touched" class="invalid-feedback">
            <span *ngIf="form.get('confirmarSenha')?.errors?.['required']">Confirmação é obrigatória.</span>
          </div>
          <div *ngIf="form.errors?.['mismatch'] && form.get('confirmarSenha')?.touched" class="invalid-feedback">
            As senhas não coincidem.
          </div>
        </div>
      </ng-container>

      <!-- FORGOT FLOW -->
      <ng-container *ngIf="mode === 'forgot'">

        <!-- STEP: Email -->
        <ng-container *ngIf="forgotFlowStep === 'email'">
          <div class="input-group">
            <label for="email">E-mail</label>
            <input type="email" id="email" formControlName="email" class="form-control" />
            <div *ngIf="form.get('email')?.invalid && form.get('email')?.touched" class="invalid-feedback">
              <span *ngIf="form.get('email')?.errors?.['required']">E-mail é obrigatório.</span>
              <span *ngIf="form.get('email')?.errors?.['email']">E-mail inválido.</span>
            </div>
          </div>
        </ng-container>

        <!-- STEP: Code -->
        <ng-container *ngIf="forgotFlowStep === 'code'">
          <div class="input-group">
            <label for="email">E-mail</label>
            <input type="email" id="email-readonly" formControlName="email" class="form-control" readonly />
          </div>

          <div class="input-group">
            <label for="code">Código de 6 dígitos</label>
            <input type="text" id="code" formControlName="code" class="form-control" />
            <div *ngIf="form.get('code')?.invalid && form.get('code')?.touched" class="invalid-feedback">
              <span *ngIf="form.get('code')?.errors?.['required']">Código é obrigatório.</span>
              <span *ngIf="form.get('code')?.errors?.['minlength'] || form.get('code')?.errors?.['maxlength']">O código deve ter 6 dígitos.</span>
            </div>
          </div>
        </ng-container>

        <!-- STEP: Password -->
        <ng-container *ngIf="forgotFlowStep === 'password'">
          <div class="input-group">
            <label for="senha">Nova Senha</label>
            <input type="password" id="senha" formControlName="senha" class="form-control" />
            <div *ngIf="form.get('senha')?.invalid && form.get('senha')?.touched" class="invalid-feedback">
              <span *ngIf="form.get('senha')?.errors?.['required']">Senha é obrigatória.</span>
              <span *ngIf="form.get('senha')?.errors?.['minlength']">Senha deve ter no mínimo 6 caracteres.</span>
            </div>
          </div>

          <div class="input-group">
            <label for="confirmarSenha">Confirmar Nova Senha</label>
            <input type="password" id="confirmarSenha" formControlName="confirmarSenha" class="form-control" />
            <div *ngIf="form.get('confirmarSenha')?.invalid && form.get('confirmarSenha')?.touched" class="invalid-feedback">
              <span *ngIf="form.get('confirmarSenha')?.errors?.['required']">Confirmação é obrigatória.</span>
            </div>
            <div *ngIf="form.errors?.['mismatch'] && form.get('confirmarSenha')?.touched" class="invalid-feedback">
              As senhas não coincidem.
            </div>
          </div>
        </ng-container>

      </ng-container>

      <!-- Submit -->
      <button type="submit" class="submit-button" [disabled]="isLoading || form.invalid">
        <ng-container *ngIf="!isLoading && mode === 'verify'">Verificar Conta</ng-container>
        <ng-container *ngIf="!isLoading && mode === 'reset'">Salvar Nova Senha</ng-container>

        <ng-container *ngIf="!isLoading && mode === 'forgot'">
          <span *ngIf="forgotFlowStep === 'email'">Solicitar Código</span>
          <span *ngIf="forgotFlowStep === 'code'">Validar Código</span>
          <span *ngIf="forgotFlowStep === 'password'">Salvar Nova Senha</span>
        </ng-container>

        <span *ngIf="isLoading">Aguarde...</span>
      </button>

      <!-- Link para solicitar novo código (usa método público no TS) -->
      <div class="mt-3 text-center" *ngIf="mode === 'forgot' && (forgotFlowStep === 'code' || forgotFlowStep === 'password')">
        <a class="link-like" (click)="restartForgotFlow()">Solicitar Novo Código</a>
      </div>

    </form>
  </div>
</div>

<app-footer></app-footer>
