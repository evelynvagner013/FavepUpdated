<div>
  <div class="chat-widget"
       #chatWidget
       [class.open]="isChatOpen"
       [attr.data-theme]="currentTheme"
       [attr.data-accent]="currentAccent">

    <header class="chat-header" (mousedown)="onDragStart($event)" (touchstart)="onDragStart($event)">
      <div class="header-content">
        <div class="header-logo-bot">
          <i class="fas fa-seedling"></i>
        </div>
        <div class="header-text">
          <h3>Sementinha</h3>
          <p [ngSwitch]="status">
            <span *ngSwitchCase="'processing'">Online</span>
            <span *ngSwitchCase="'speaking'">Estou falando...</span>
            <span *ngSwitchDefault>Online</span>
          </p>
        </div>
      </div>
      <div class="header-actions">
        <button
          class="header-btn"
          (click)="toggleSettings()"
          [ngClass]="{ 'active': isSettingsOpen }"
          aria-label="Abrir configurações"
          title="Abrir configurações de tema">
          <i class="fas fa-cog"></i>
        </button>
        <button
          class="header-btn"
          (click)="handleHeaderClick($event, 'readAloud')"
          [ngClass]="{ 'active': readAloudEnabled }"
          aria-label="Ativar leitura em voz alta"
          title="Ativar/Desativar leitura das respostas">
          <i class="fas" [ngClass]="readAloudEnabled ? 'fa-volume-up' : 'fa-volume-mute'"></i>
        </button>
        <button class="header-btn close-chat-btn" (click)="handleHeaderClick($event, 'close')" aria-label="Fechar chat">&times;</button>
      </div>
    </header>

    <main class="chat-body" #chatBody>
      <div *ngFor="let message of messages"
           class="message-wrapper"
           [ngClass]="{'user-message-wrapper': message.sender === 'user', 'agent-message-wrapper': message.sender === 'agent'}">

        <div *ngIf="message.sender === 'agent'" class="agent-message-content">
          <div class="agent-avatar">
            <i class="fas fa-seedling"></i>
          </div>
          <div class="message-group">
            <div class="agent-name">Sementinha</div>
            <div class="message-bubble">
              <p>{{ message.text }}</p>
            </div>
          </div>
        </div>

        <div *ngIf="message.sender === 'user'" class="user-message-content">
          <div class="message-bubble">
            <p>{{ message.text }}</p>
          </div>
        </div>
      </div>

      <div *ngIf="status === 'processing'" class="message-wrapper agent-message-wrapper">
        <div class="agent-message-content">
          <div class="agent-avatar">
            <i class="fas fa-seedling"></i>
          </div>
          <div class="message-group">
            <div class="agent-name">Sementinha</div>
            <div class="message-bubble typing-indicator">
              <span></span><span></span><span></span>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="chat-footer">
      <form (ngSubmit)="sendTextMessage()" class="chat-input-form">
        <input type="text" [(ngModel)]="currentMessage" name="currentMessage" placeholder="Digite sua pergunta..." aria-label="Campo de texto para pergunta">
        <button *ngIf="currentMessage" type="submit" class="send-btn" [disabled]="!currentMessage.trim()" aria-label="Enviar mensagem">
          <i class="fas fa-paper-plane"></i>
        </button>
      </form>
    </footer>

    <div class="chat-settings" *ngIf="isSettingsOpen">
      <div class="settings-header">
        <button class="header-btn" (click)="toggleSettings()" title="Voltar para o chat">
          <i class="fas fa-arrow-left"></i>
        </button>
        <h4>Configurações</h4>
      </div>
      <div class="settings-body">
        <div class="settings-section">
          <h5>Tema</h5>
          <div class="theme-selector">
            <button (click)="setTheme('light')" [class.active]="currentTheme === 'light'">
              <i class="fas fa-sun"></i> Light
            </button>
            <button (click)="setTheme('dark')" [class.active]="currentTheme === 'dark'">
              <i class="fas fa-moon"></i> Dark
            </button>
          </div>
        </div>
        <div class="settings-section">
          <h5>Cor de Destaque</h5>
          <div class="color-selector">
            <button
              *ngFor="let accent of availableAccents"
              class="color-dot"
              [ngClass]="accent + (currentAccent === accent ? ' active' : '')"
              (click)="setAccent(accent)"
              [title]="accent">
            </button>
          </div>
        </div>
      </div>
    </div>

  </div> <button
    class="voice-assistant-fab"
    (click)="toggleChat()"
    [title]="isChatOpen ? 'Fechar Chat' : 'Abrir Chat com a Assistente'">
    <div *ngIf="!isChatOpen" class="bot-face-fab">
      <i class="fas fa-seedling"></i>
    </div>
    <div *ngIf="isChatOpen" class="close-icon-fab">
      <span></span>
      <span></span>
    </div>
  </button>
</div>
