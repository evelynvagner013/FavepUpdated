<header>
  <div class="logo">
    <img src="assets/img/FAVEP_LOGO_nobg.png" alt="Logo FAVEP" class="header-logo-img">
    FAVEP
  </div>

  <div class="menu-toggle" (click)="alternarMenu()">
    <span class="material-symbols-outlined">menu</span>
  </div>

  <div class="navbar-menu" [class.active]="menuAberto">
    <nav>
      <a href="/home" (click)="fecharMenu()">Início</a>
      <a href="#services" (click)="fecharMenu()">Serviços</a>
      <a href="/parceiros" (click)="fecharMenu()">Parceiros</a>
      <a href="/contato" (click)="fecharMenu()">Contato</a>
    </nav>

    <div class="auth-section">
      <div *ngIf="!currentUserValue">
        <a (click)="abrirLoginModal(); fecharMenu()" class="sign-in">Acessar</a>
      </div>

      <div *ngIf="currentUserValue" class="user-info">
        <span class="welcome-user">Seja bem vindo, {{ currentUserValue.nome }}!</span>
        <div class="user-menu">
          <img [src]="currentUserValue.fotoperfil || 'assets/img/usuario.jpg'" alt="Foto do Perfil" class="profile-pic" (click)="toggleDropdown($event)">

          <div class="dropdown-menu" *ngIf="mostrarDropdown">
            <a routerLink="/gerenciamento" class="painel-controle" (click)="fecharMenu()">Gerenciar</a>
            <a routerLink="/usuario" class="modal-perfil" (click)="fecharMenu()">Perfil</a>
            <a (click)="logout(); fecharMenu()" class="logout-link">Sair</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="auth-modal-overlay"
     [style.display]="(mostrarLoginModal || mostrarRegisterModal || mostrarForgotPasswordModal || mostrarVerifyEmailModal || isCompleteProfileModalOpen) ? 'flex' : 'none'"
     [class.active]="mostrarLoginModal || mostrarRegisterModal || mostrarForgotPasswordModal || mostrarVerifyEmailModal || isCompleteProfileModalOpen">

  <div class="auth-modal-container login-form-container" *ngIf="mostrarLoginModal" (click)="$event.stopPropagation()">
    <h2 class="auth-modal-title">Logar</h2>
    <button (click)="fecharModals()" class="auth-modal-close-button">
      <svg xmlns="http://www.w3.org/2000/svg" width="3.5vh" height="3.5vh" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
      </svg>
    </button>
    <form (ngSubmit)="onLoginSubmit()" #loginNgForm="ngForm">
      <div class="inputs">
        <div class="inputs-container">
          <input type="email" id="loginEmail" name="loginEmail" [(ngModel)]="loginEmail" placeholder="Insira seu e-mail" required />
        </div>
        <div class="inputs-container password-container">
          <input
            [type]="loginPasswordVisible ? 'text' : 'password'"
            id="loginPassword"
            name="loginPassword"
            [(ngModel)]="loginPassword"
            placeholder="Insira sua senha"
            required
          />
          <i
            class="password-toggle-icon"
            [ngClass]="loginPasswordVisible ? 'fas fa-eye-slash' : 'fas fa-eye'"
            (click)="toggleLoginPasswordVisibility()"
          ></i>
        </div>
      </div>
      <div class="botões">
        <div class="lembre-me">
          <div class="checkbox">
            <input  type="checkbox" name="loginCheck" id="loginCheck" [(ngModel)]="lembreMe">
            <label for="loginCheck">Lembre-me email</label>
          </div>
        </div>
        <a class="senha" (click)="abrirForgotPasswordModal()">Esqueceu a senha?</a>
      </div>
      <div class="auth-actions">
        <a (click)="abrirRegisterModal()" class="auth-link">Não tem conta? Cadastrar-se</a>
      </div>
      <div class="confirmarBotao">
        <input class="confirmar" type="submit" value="Confirmar" [disabled]="!loginNgForm.form.valid" />
      </div>
      <div class="message error" *ngIf="loginErrorMessage">{{ loginErrorMessage }}</div>
    </form>
  </div>

  <div class="auth-modal-container registration-form-container" *ngIf="mostrarRegisterModal" (click)="$event.stopPropagation()">
    <button (click)="fecharModals()" class="auth-modal-close-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="3.5vh" height="3.5vh" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
          <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
        </svg>
    </button>
    <div class="registration-header">
      <h2 class="auth-modal-title">Registre-se</h2>
    </div>
    <form (ngSubmit)="onRegisterSubmit()" #registerNgForm="ngForm" class="registration-actual-form">
      <div class="form-line">
        <input type="text" name="regUsername" placeholder="Digite seu nome" [(ngModel)]="registerUser.nome" required>
      </div>
      <div class="form-line">
        <input type="email" name="regEmail" placeholder="Digite seu e-mail" [(ngModel)]="registerUser.email" required>
      </div>
      <div class="form-line">
        <input
          type="tel"
          name="regTelefone"
          placeholder="Digite seu telefone"
          [(ngModel)]="registerUser.telefone"
          mask="(00) 00000-0000"
          required>
      </div>

      <div class="form-line">
        <input type="password" name="regSenha" placeholder="Digite sua senha" [(ngModel)]="registerUser.senha" required minlength="6">
      </div>
      <div class="form-line">
        <input type="password" name="regConfirmarSenha" placeholder="Confirme sua senha" [(ngModel)]="registerUser.confirmarSenha" required>
      </div>
      <div style="padding: 15px; background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; border-radius: 5px;">
        <strong>Atenção:</strong> Use um e-mail real. Você receberá um código de 6 dígitos para verificação.
      </div>

      <div class="auth-actions">
        <a (click)="abrirLoginModal()" class="auth-link">Já tem uma conta? Entrar</a>
      </div>
      <button type="submit" class="register-submit-button" [disabled]="!registerNgForm.form.valid">Cadastrar</button>
      <div class="message success" *ngIf="registerSuccessMessage">{{ registerSuccessMessage }}</div>
      <div class="message error" *ngIf="registerErrorMessage">{{ registerErrorMessage }}</div>
    </form>
  </div>

  <div class="auth-modal-container verification-form-container" *ngIf="mostrarVerifyEmailModal" (click)="$event.stopPropagation()">
    <h2 class="auth-modal-title">Verificar E-mail</h2>
    <button (click)="fecharModals()" class="auth-modal-close-button">
      <svg xmlns="http://www.w3.org/2000/svg" width="3.5vh" height="3.5vh" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
      </svg>
    </button>
    <form (ngSubmit)="onVerifyCodeSubmit()" #verifyCodeNgForm="ngForm">
      <div style="padding: 15px; background-color: #e2f3ff; border: 1px solid #b8daff; color: #0c5460; border-radius: 5px;">
        Enviamos um código de 6 dígitos para <strong>{{ emailParaVerificar }}</strong>.
        <br>Por favor, verifique sua caixa de entrada (e spam).
      </div>
      <div class="inputs" style="margin-top: 15px;">
        <div class="inputs-container">
          <input
            type="text"
            id="verificationCode"
            name="verificationCode"
            [(ngModel)]="verificationCode"
            placeholder="Insira o código de 6 dígitos"
            required
            maxlength="6"
            style="text-align: center; font-size: 1.2rem; letter-spacing: 3px;"
            />
        </div>
      </div>
      <div class="confirmarBotao">
        <input class="confirmar" type="submit" value="Verificar" [disabled]="!verifyCodeNgForm.form.valid" />
      </div>
      <div class="message success" *ngIf="verifySuccessMessage">{{ verifySuccessMessage }}</div>
      <div class="message error" *ngIf="verifyErrorMessage">{{ verifyErrorMessage }}</div>
    </form>
  </div>

  <div class="auth-modal-container forgot-password-form-container" *ngIf="mostrarForgotPasswordModal" (click)="$event.stopPropagation()">
    <button (click)="fecharModals()" class="auth-modal-close-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="3.5vh" height="3.5vh" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
        </svg>
    </button>
    <form (ngSubmit)="onForgotPasswordSubmit()" #forgotPasswordNgForm="ngForm">

        <h2 class="auth-modal-title" *ngIf="forgotFlowStep === 'email'">Recuperar Senha</h2>
        <h2 class="auth-modal-title" *ngIf="forgotFlowStep === 'code'">Verificar Código</h2>
        <h2 class="auth-modal-title" *ngIf="forgotFlowStep === 'password'">Definir Nova Senha</h2>

        <div *ngIf="forgotFlowStep === 'email'" style="width: 100%;">
          <div style="padding: 15px; background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; border-radius: 5px; margin-bottom: 15px;">
            <strong>Atenção:</strong> Insira seu e-mail para enviarmos um código de 6 dígitos.<br>
          </div>
          <div class="inputs">
              <div class="inputs-container">
                  <input type="email" id="forgotPasswordEmail" name="forgotPasswordEmail" [(ngModel)]="forgotEmail" placeholder="Insira seu e-mail de cadastro" required />
              </div>
          </div>
        </div>

        <div *ngIf="forgotFlowStep === 'code'" style="width: 100%;">
          <div style="padding: 15px; background-color: #e2f3ff; border: 1px solid #b8daff; color: #0c5460; border-radius: 5px; margin-bottom: 15px;">
            Enviamos um código de 6 dígitos para <strong>{{ forgotEmail }}</strong>.
          </div>
          <div class="inputs">
            <div class="inputs-container">
              <input
                type="text"
                id="forgotCode"
                name="forgotCode"
                [(ngModel)]="forgotCode"
                placeholder="Insira o código de 6 dígitos"
                required
                maxlength="6"
                style="text-align: center; font-size: 1.2rem; letter-spacing: 3px;"
              />
            </div>
          </div>
        </div>

        <div *ngIf="forgotFlowStep === 'password'" style="width: 100%;">
          <div style="padding: 15px; background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; border-radius: 5px; margin-bottom: 15px;">
            Código validado! Defina sua nova senha.
          </div>
          <div class="inputs">
            <div class="inputs-container password-container">
              <input
                [type]="forgotPasswordVisible ? 'text' : 'password'"
                id="forgotNewPassword"
                name="forgotNewPassword"
                [(ngModel)]="forgotNewPassword"
                placeholder="Insira sua nova senha"
                required
                minlength="6"
              />
              <i
                class="password-toggle-icon"
                [ngClass]="forgotPasswordVisible ? 'fas fa-eye-slash' : 'fas fa-eye'"
                (click)="toggleForgotPasswordVisibility()"></i>
            </div>
            <div class="inputs-container password-container">
              <input
                [type]="forgotConfirmPasswordVisible ? 'text' : 'password'"
                id="forgotConfirmPassword"
                name="forgotConfirmPassword"
                [(ngModel)]="forgotConfirmPassword"
                placeholder="Confirme sua nova senha"
                required
              />
              <i
                class="password-toggle-icon"
                [ngClass]="forgotConfirmPasswordVisible ? 'fas fa-eye-slash' : 'fas fa-eye'"
                (click)="toggleForgotConfirmPasswordVisibility()"></i>
            </div>
          </div>
        </div>

        <div class="auth-actions">
            <a (click)="abrirLoginModal()" class="auth-link">Lembrou a senha? Voltar para o Login</a>
        </div>
        <div class="confirmarBotao">
            <input *ngIf="forgotFlowStep === 'email'" class="confirmar" type="submit" value="Enviar Código" [disabled]="!forgotPasswordNgForm.form.valid" />
            <input *ngIf="forgotFlowStep === 'code'" class="confirmar" type="submit" value="Validar Código" [disabled]="!forgotPasswordNgForm.form.valid" />
            <input *ngIf="forgotFlowStep === 'password'" class="confirmar" type="submit" value="Salvar Nova Senha" [disabled]="!forgotPasswordNgForm.form.valid" />
        </div>

        <div class="message success" *ngIf="forgotSuccessMessage">{{ forgotSuccessMessage }}</div>
        <div class="message error" *ngIf="forgotErrorMessage">{{ forgotErrorMessage }}</div>
    </form>
  </div>

  <div class="auth-modal-container complete-profile-form-container" *ngIf="isCompleteProfileModalOpen" (click)="$event.stopPropagation()">
    <button (click)="fecharModals()" class="auth-modal-close-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="3.5vh" height="3.5vh" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
        </svg>
    </button>

    <h2 class="auth-modal-title" *ngIf="subUserStep === 'code'">Verificação de Segurança</h2>
    <h2 class="auth-modal-title" *ngIf="subUserStep === 'details'">Completar Perfil</h2>

    <div *ngIf="subUserStep === 'code'" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
        <div style="padding: 15px; background-color: #e2f3ff; border: 1px solid #b8daff; color: #0c5460; border-radius: 5px; margin-bottom: 15px; width: 100%; box-sizing: border-box;">
            <i class="fas fa-info-circle"></i> Primeiro acesso detectado.<br>
            Enviamos um código de 6 dígitos para <strong>{{subUserTempData.email}}</strong>.
        </div>

        <div class="inputs">
            <div class="inputs-container">
                <input
                type="text"
                name="subUserCode"
                [(ngModel)]="subUserTempData.code"
                placeholder="000000"
                required
                maxlength="6"
                style="text-align: center; font-size: 1.2rem; letter-spacing: 3px;"
                />
            </div>
        </div>

        <div class="confirmarBotao">
            <input class="confirmar" type="button" value="Verificar" (click)="onSubUserCodeSubmit()" />
        </div>
    </div>

    <form *ngIf="subUserStep === 'details'" (ngSubmit)="onSubUserFinalizeSubmit()" #subUserForm="ngForm" class="registration-actual-form">
        <div style="padding: 10px; background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; border-radius: 5px; width: 100%; margin-bottom: 10px; box-sizing: border-box; text-align: center;">
            Código verificado! Complete seus dados.
        </div>

        <div class="form-line">
            <input type="text" name="subNome" placeholder="Seu nome completo" [(ngModel)]="subUserTempData.nome" required>
        </div>
        <div class="form-line">
            <input type="tel" name="subTelefone" placeholder="Seu telefone" [(ngModel)]="subUserTempData.telefone" required mask="(00) 00000-0000">
        </div>
        <div class="form-line">
            <input type="password" name="subSenha" placeholder="Nova senha segura" [(ngModel)]="subUserTempData.senha" required minlength="8">
        </div>
        <div class="form-line">
            <input type="password" name="subConfirmSenha" placeholder="Confirme a nova senha" [(ngModel)]="subUserTempData.confirmarSenha" required>
        </div>

        <div class="confirmarBotao" style="margin-top: 15px;">
            <input class="confirmar" type="submit" value="Concluir Cadastro" [disabled]="!subUserForm.form.valid || isLoading" />
        </div>
    </form>

    <div class="message error" *ngIf="subUserError">{{ subUserError }}</div>
    <div class="message success" *ngIf="subUserSuccess">{{ subUserSuccess }}</div>

  </div>

</div>

<div class="modal-overlay" [class.active]="mostrarPerfilModal" *ngIf="mostrarPerfilModal" (click)="fecharModalPerfil()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
            <h3>Editar Perfil</h3>
            <button class="close-btn" (click)="fecharModalPerfil()" aria-label="Fechar modal">&times;</button>
        </div>
        <form (ngSubmit)="salvarAlteracoesPerfil()" #perfilForm="ngForm">
            <div class="modal-body">
                <div class="profile-photo-preview-container">
                    <img [src]="usuarioEditavel.fotoperfil || 'assets/img/usuario.jpg'" alt="Pré-visualização da foto" class="profile-photo-preview">
                </div>
                <div class="form-group file-upload-group">
                    <label for="file-upload" class="file-upload-label">
                        <i class="fas fa-upload"></i> Escolher Nova Foto
                    </label>
                    <input id="file-upload" type="file" (change)="onFileSelected($event)" accept="image/png, image/jpeg, image/gif">
                </div>
                <div class="form-group">
                    <label for="edit-nome">Nome:</label>
                    <input type="text" id="edit-nome" name="nome" [(ngModel)]="usuarioEditavel.nome" required #nomeInput="ngModel">
                    <div *ngIf="nomeInput.invalid && (nomeInput.dirty || nomeInput.touched)" class="validation-error">
                        <small *ngIf="nomeInput.errors?.['required']">Nome é obrigatório.</small>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-email">Email:</label>
                    <input type="email" id="edit-email" name="email" [(ngModel)]="usuarioEditavel.email" required email #emailInput="ngModel">
                    <div *ngIf="emailInput.invalid && (emailInput.dirty || emailInput.touched)" class="validation-error">
                        <small *ngIf="emailInput.errors?.['required']">Email é obrigatório.</small>
                        <small *ngIf="emailInput.errors?.['email']">Formato de email inválido.</small>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-telefone">Telefone:</label>
                    <input type="tel" id="edit-telefone" name="telefone" [(ngModel)]="usuarioEditavel.telefone" mask="(00) 00000-0000">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" (click)="fecharModalPerfil()">Cancelar</button>
                <button type="submit" class="btn-save" [disabled]="!perfilForm.form.valid">Salvar</button>
            </div>
        </form>
    </div>
</div>
